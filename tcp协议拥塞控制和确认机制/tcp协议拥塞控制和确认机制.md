# 实现udp可靠数据传输-kcp协议理论基础


### 探究背景


- 实时低延迟网络数据传输：实时语音视频、帧同步数据传输等

- 帧同步技术使用kcp协议，网络波动或弱网时优化数据传输，降低延迟

### 帧同步技术使用tcp协议存在什么问题？
帧同步技术数据处理主要耗时：帧数据收集+网络数据传输往返

考量：低延迟

### tcp协议和udp协议

||tcp协议|udp协议|
|-|-|-|
|<span style="display:inline-block;width:100px">定义</span>|面向连接的、可靠的、基于字节流的传输层通讯协议(机制不像kcp激进)|<span style="display:inline-block;width:150px">提供一种以最少的协议机制向其他程序发送消息的协议</span>|
|协议背景|在不可靠的的互联网上提供可靠数据传输|不可靠数据传输，尽最大努力交付|
|*连接|三次握手(弱网时可能断开重复)|无连接|
|维持不丢包|***ARQ协议***（Automatic Repeat-reQuest），自动重传请求，确认和超时两个机制|-|
|* 确认机制|ack确认应答；***累计确认***；***延迟ack***||
|*拥塞控制|目的是为了维持数据传输的稳定性。可能会主动降低发送速率(kcp牺牲带宽)，提高整体网络的稳定性；主要机制：***慢启动***、快速重传|-|
|发送方没收到ack时处理 |可继续发数据包的条件是***滑动窗口***（~~发送窗口~~）未满；不能发的条件是窗口满了或需要重传旧数据；设计理念是通过保守的窗口管理和重传机制维护网络公平性|-|
|*重传机制-超时重传|通常略大于往返时间，过长重传效率低，过短重传频率上升，加剧网络拥塞(tcp计算机制相对保守;kcp机制相对激进，计算RTO公式不同)|-|
|*重传机制-快速重传|**发送方根据收到3个冗余ack**(kcp优化)立即触发重传。接收方发现没收到上一个包时（比如乱序）会返回上一个包ack，往后继续收到其它包还没收到，继续返回该ack；考量是避免因网络短暂乱序，区分是丢包还是短暂乱序|-|
|断开|四次挥手|无连接释放|



#### **tcp滑动窗口**

场景：发送方发了数据，一定时间内没收到ack时处理，是继续发还是停止发？

定义：用于控制、管理**发送方**和**接收方**之间的数据传输，是实现tcp流量控制和拥塞控制的基础

组成：发送窗口（发送方维护）、接收窗口（接收方维护）；

发送窗口：由接收方接收窗口大小和网络拥塞情况共同决定，发送方可以持续发送数据直到已发送但未确认的数据量达到窗口上限；

接收窗口：收到发送方数据数据和窗口初始化大小重新计算，并将此新的窗口大小通过tcp报名字段的窗口大小告知发送方；

作用：发送方可以持续发送数据而不需要等待每个数据确认，从而提高效率；

优化点：

- 窗口变化策略：可以自定义窗口变化策略，比如更快的窗口增长或更慢的减少速度；	

  

#### **慢启动**

定义：是一种tcp发送数据时控制发送速率的算法，主要目的是逐渐增加发送速率（指数增长），慢慢探测网络的容量，避免在网络拥塞时速度增加过快导致更严重的拥塞；

**核心机制**：

- 初始阶段：连接建立或超时重传后，发送方将***拥塞窗口***（cwnd）初始化为1个MSS（最大报文段大小 实际传输大约为1k），并逐步增加发送数据量；
- 窗口增加方式：每收到一个ACK确认，cwnd增加1个MSS，1k, 2k, 4k, 8k....；
- 初始化阈值：开始设置一个较大的值，当拥塞窗口达到一个特定的值（拥塞避免阶段），会记录拥塞阈值，用于控制后续拥塞控制；
- 阈值控制：当cwnd达到慢启动阈值（ssthresh）时，进入拥塞避免阶段，转为线性增长（每RTT增加1个MSS）
- 发生数据包丢失（通过超时或重复ACK判断）时，将ssthresh设为当前cwnd的一半，并重置cwnd为1
- 阶段变化幅度：指数增长→线性增长→拥塞处理

### **tcp拥塞窗口**

定义：拥塞窗口是发送方维护的一个数值，它反映了网络拥塞的程度。TCP使用拥塞控制算法（如慢启动、拥塞避免、快速重传和快速恢复）来动态调整拥塞窗口的大小，是一个动态调整的窗口大小。拥塞窗口的大小决定了在任意时刻可以发送到网络中的数据包的最大数量



### tcp累计确认和选择性确认sack

累计确认：假设有数据包1、2、3、4、5，发送方发了1，接收方通过返回一个ACK号（例如ACK=1），表示已正确接收序号为1的数据包。这时如果收到了3，接收方仍只能发送ACK=2，无法告知发送方后续数据是否到达，即使后续数据包4、5已到达（累积ACK机制局限性，sack优化）

无sack时：当中间的数据包丢失时，会重传中间丢失的包和后续的包（冗余重传）；

选择性确认sack：可选扩展机制，需要双方协商启用，在ACK报文中附加“SACK块”，明确告知发送方‌哪些非连续的数据块已成功接收看，重传时只重传丢失的包；

| 机制                                                         | 优势                                 | 带来问题                         | 适用场景                           |
| ------------------------------------------------------------ | ------------------------------------ | -------------------------------- | ---------------------------------- |
| <span style="display:inline-block;width:160px">累积ACK（基础项）</span> | 简单、兼容性强、资源消耗低           | 冗余重传问题严重                 | 老旧设备、低复杂度网络（如局域网） |
| SACK（扩展项）                                               | 减少冗余重传、提升高丢包网络传输效率 | 需协商支持开启选项、头部开销增加 | 网络波动可能丢包环境               |

### **延迟ack机制**

定义：指接收方在接收到数据后，不会立即发送ACK确认包，而是会延迟一段时间再发送；

机制：通常每隔200毫秒检查一次是否有ack需要发送，如果在这200毫秒内接收方收到了更多的数据包，这些ACK可以合并在一起发送

优点：可以合并多个ack包，减少传输次数；

优化点：如需更快确认可以取消延迟ack机制，收到包可以立即回复ack



### tcp ARQ协议

定义：自动重传请求，过使用**确认**和**超时**这两个机制，是实现可靠数据传输的核心机制，通过确认应答、超时重传和错误检测等机制保障数据完整性和传输可靠性；

组成：停止等待ARQ协议、连续ARQ协议；

##### **停止等待ARQ**‌

原理：发送方每发送一个数据分组后暂停，等待接收方的确认（ACK），若超时未收到ACK，则重传该分组‌

优点：实现简单，适用于需要高可靠性（数据的完整性和准确性），例如金融交易，网络条件较差时可靠性优势更明显；

缺点：带宽利用率可能不高，大部分时间花在等待等待确认上；

##### **连续ARQ协议**

原理：‌允许发送方连续发送多个分组（窗口内数据），无需逐个等待确认，大幅提升传输效率‌

实现方式：

- 回退N帧（GBN）‌：若某分组丢失，发送方需重传该分组及之后所有已发送分组‌
- 选择性重传（SR）‌：仅重传丢失或错误的分组，需接收方缓存乱序到达的分组‌

**选择停止等待ARQ还是连续ARQ协议？**

TCP协议并非在停止等待ARQ和连续ARQ之间机制二选一，而是通过‌网络拥塞状态将两者的核心机制融合

1. 连续发送‌为主：通过滑动窗口最大化吞吐量‌
2. 按需降级‌：网络异常时缩小窗口或触发超时重传，局部退化为类似停止等待的模式‌
3. 机制融合‌：将两种ARQ的核心思想分层整合，形成兼顾可靠性与效率的传输体系‌

### **tcp ARQ协议实现机制**

1. **确认应答（ACK）‌**
   - 接收方成功接收数据后返回ACK，发送方根据序列号确认已正确接收范围

   - 累积确认‌：仅确认按序到达的最高序列号分组（如GBN）‌

   - 选择性确认‌：允许单独确认乱序到达的分组（如SR）‌
2. **超时重传**‌
   - 发送方为每个分组设置超时计时器，若超时未收到ACK则重传‌
   - 动态超时时间‌：根据网络往返时间（RTT）动态调整超时阈值，避免过早或过晚重传‌
3. **快速重传机制**‌
   - 当发送方连续收到3个重复ACK时，立即重传对应分组（无需等待超时），减少延迟‌
4. **流量控制**
   - 滑动窗口机制‌：动态调整发送窗口大小，匹配接收方处理能力和网络拥塞状态‌
   - 结合慢启动、拥塞避免等算法动态调整发送速率，避免网络拥塞‌
